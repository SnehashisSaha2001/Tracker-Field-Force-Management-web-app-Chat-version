<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tracker Field Force</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0e2a47',
                        accent: '#00d4ff',
                        darkbg: '#0f2027',
                        cardbg: '#1e2e3e',
                        inputbg: '#324a5f',
                        success: '#28a745',
                        danger: '#f44336',
                        // WhatsApp Inspired Colors
                        chatbg: '#0b141a',
                        chatheader: '#202c33',
                        chatpanel: '#111b21',
                        msgout: '#005c4b',
                        msgin: '#202c33',
                        teal: '#00a884'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    backgroundImage: {
                        'main-gradient': 'linear-gradient(to bottom right, #0f2027, #203a43, #2c5364)',
                        'chat-pattern': "url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')"
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
            color: #f1f1f1;
            height: 100vh;
            overflow: hidden;
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374045; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a555b; 
        }
        .leaflet-container {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            z-index: 0;
        }
        /* Table Styling overrides */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2b3d50;
        }
        th, td {
            border: 1px solid #00d4ff;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #324a5f;
            color: #f1f1f1;
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #324a5f inset !important;
            -webkit-text-fill-color: white !important;
        }
        .proto-input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background: #324a5f;
            color: #fff;
            outline: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .location-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Chat Specifics */
        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            margin-bottom: 4px;
            font-size: 0.95rem;
            line-height: 1.4;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }
        .message-sent {
            background-color: #005c4b;
            border-top-right-radius: 0;
            margin-left: auto;
        }
        .message-received {
            background-color: #202c33;
            border-top-left-radius: 0;
            margin-right: auto;
        }
        .message-time {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            float: right;
            margin-left: 8px;
            margin-top: 6px;
        }
        .chat-bg-pattern {
            background-color: #0b141a;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat;
            opacity: 0.06;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .online-dot {
            height: 10px;
            width: 10px;
            background-color: #28a745;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #111b21;
        }
    </style>
    <script>
      // Suppress Babel warning
      console.warn = (function(warn) {
        return function(message, ...args) {
          if (typeof message === 'string' && message.includes('In-browser Babel transformer')) return;
          warn.apply(console, [message, ...args]);
        };
      })(console.warn);
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://yuuzmvjkxzwmisvxkbpk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dXptdmpreHp3bWlzdnhrYnBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTE4NDAsImV4cCI6MjA3OTg2Nzg0MH0.bDwJTetMoOJIh0rNuvWADtD_5VLLfW0uaPijv8Zo6O0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Initial Data ---
        const INITIAL_ADMINS = [
            { user_id: "ADM-S.S SINGH", name: "Shanti Saran Singh", mobile_no: "9831038262", password: "scube@1234", role: 'admin' },
            { user_id: "ADM-SANDEEP", name: "Sandeep Sarkar", mobile_no: "9831036858", password: "scube@1234", role: 'admin' },
            { user_id: "ADM-SNEHASHIS", name: "Snehashis Saha", mobile_no: "9330199588", password: "scube@1234", role: 'admin' },
            { user_id: "ADM-KOMAL", name: "Komal Gupta", mobile_no: "7003045682", password: "scube@1234", role: 'admin' },
            { user_id: "ADM-SHOAIB", name: "MD Shoaib Raza", mobile_no: "9831259095", password: "scube@1234", role: 'admin' },
            { user_id: "ADM-ADMIN", name: "System Admin", mobile_no: "9999999999", password: "scube@1234", role: 'admin' }
        ];

        const INITIAL_EMPLOYEES = [
            { name: "Snehasish Paul", user_id: "SCS-03318", mobile_no: "8017892062", password: "scube@4321", role: 'employee' },
            { name: "Zuber Alam", user_id: "SCS-01102", mobile_no: "9891377424", password: "scube@4321", role: 'employee' },
            { name: "Bharath Kumar TM", user_id: "SCS-08017", mobile_no: "9844722312", password: "scube@4321", role: 'employee' },
            { name: "Shiva Kumarar", user_id: "SCS-08016", mobile_no: "9611452782", password: "scube@4321", role: 'employee' },
            { name: "Tapas Kumar Dinda", user_id: "SCS-03317", mobile_no: "9804443387", password: "scube@4321", role: 'employee' },
            { name: "Gopal Chandra Biswas", user_id: "SCS-03313", mobile_no: "9432095612", password: "scube@4321", role: 'employee' },
            { name: "Saugat Majumdar", user_id: "SCS-03303", mobile_no: "9831259094", password: "scube@4321", role: 'employee' },
            { name: "Chitrarath Senapati", user_id: "SCS-03306", mobile_no: "9831282190", password: "scube@4321", role: 'employee' },
            { name: "Sukhendu Shekhar Mondal", user_id: "SCS-03316", mobile_no: "7278942388", password: "scube@4321", role: 'employee' },
            { name: "Tarun Kumar Paramanik", user_id: "SCS-03308", mobile_no: "9831650969", password: "scube@4321", role: 'employee' },
            { name: "Kartik Ghanta", user_id: "SCS-03309", mobile_no: "7074099074", password: "scube@4321", role: 'employee' },
            { name: "Provat Naskar", user_id: "SCS-03314", mobile_no: "7044486602", password: "scube@4321", role: 'employee' },
            { name: "Ravi", user_id: "SCS-01103", mobile_no: "9548362042", password: "scube@4321", role: 'employee' },
            { name: "Abhilash Sarangi", user_id: "SCS-067403", mobile_no: "8763523636", password: "scube@4321", role: 'employee' },
            { name: "Kishan Kanodia", user_id: "SCS-077106", mobile_no: "7999610074", password: "scube@4321", role: 'employee' }
        ];

        // --- Utility Functions ---
        const ensureSupabaseUser = async (user) => {
            if (!user || !user.user_id) return;
            const { error } = await supabase.from('users').upsert({
                user_id: user.user_id,
                name: user.name,
                email: user.email || null,
                mobile_no: user.mobile_no,
                role: user.role,
                password: user.password,
                is_online: true,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id', ignoreDuplicates: true }); 
            
            if (error) {
                // Return error to caller for handling
                return error;
            }
        };

        const getLocalUsers = () => {
            try {
                const stored = localStorage.getItem('tracker_users');
                if (stored) return JSON.parse(stored);
            } catch (e) {
                console.error("Error reading local storage users", e);
            }
            const defaults = [...INITIAL_ADMINS, ...INITIAL_EMPLOYEES];
            localStorage.setItem('tracker_users', JSON.stringify(defaults));
            return defaults;
        };

        const updateLocalUserInStorage = (updatedUser) => {
            const users = getLocalUsers();
            const index = users.findIndex(u => u.user_id === updatedUser.user_id);
            if (index !== -1) {
                users[index] = { ...users[index], ...updatedUser };
                localStorage.setItem('tracker_users', JSON.stringify(users));
            }
        };

        const addLocalUserToStorage = (newUser) => {
            const users = getLocalUsers();
            if (!users.find(u => u.user_id === newUser.user_id)) {
                users.push(newUser);
                localStorage.setItem('tracker_users', JSON.stringify(users));
            }
        };

        const removeLocalUserFromStorage = (userId) => {
            const users = getLocalUsers().filter(u => u.user_id !== userId);
            localStorage.setItem('tracker_users', JSON.stringify(users));
        };

        const handleSupabaseError = (err) => {
            // Log full error for debugging
            try {
                console.error("Supabase Error:", JSON.stringify(err, null, 2));
            } catch(e) {
                console.error("Supabase Error (Non-serializable):", err);
            }

            // Check for missing table errors (PGRST205)
            if (err?.code === 'PGRST205' || (err?.message && err.message.includes('relation') && err.message.includes('does not exist'))) {
                // We rely on the SetupWizard to show the big modal for this, but if a specific action triggers it:
                alert("DATABASE ERROR: Tables are missing.\nPlease see the instructions on the dashboard.");
                return;
            }
            
            if (err?.code === '42501' || (err?.message && err.message.includes('row-level security'))) {
                alert("ACCESS DENIED (RLS)\nPlease run: ALTER TABLE table_name DISABLE ROW LEVEL SECURITY;");
                return;
            }

            // Extract readable message
            let msg = "Unknown Error";
            if (typeof err === 'string') msg = err;
            else if (err?.message) msg = err.message;
            else if (err?.error_description) msg = err.error_description;
            else if (err?.code) msg = `Error Code: ${err.code}`;
            else {
                try { msg = JSON.stringify(err); } catch(e) { msg = "Object could not be stringified"; }
            }
            
            if (msg === "{}") msg = "Network Error or Empty Response";
            if (msg.includes("permissions policy")) msg = "Location access blocked. Please refresh or check browser settings.";

            alert(`Operation Failed:\n${msg}`);
        };

        const exportToCSV = (data, filename) => {
            if (!data || !data.length) return alert('No data to export');
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    let val = row[header] === null || row[header] === undefined ? '' : row[header];
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',')) val = `"${val}"`;
                    return val;
                }).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Icons ---
        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>,
            Activity: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>,
            FollowUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Profile: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>,
            Admin: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>,
            Close: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>,
            Chat: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>,
            Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>,
            Back: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>,
            Error: () => <svg className="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        };

        // --- Shared Modal Component ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm">
                    <div className="bg-cardbg rounded-lg shadow-2xl w-full max-w-md relative flex flex-col max-h-[90vh] border border-accent">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <Icons.Close />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Database Setup Wizard ---
        const SetupWizard = ({ isOpen }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-lg p-4">
                    <div className="bg-cardbg rounded-2xl shadow-2xl w-full max-w-2xl border border-red-500 overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-gray-700 flex items-center gap-4 bg-red-900/20">
                            <Icons.Error />
                            <div>
                                <h1 className="text-2xl font-bold text-white">Database Setup Required</h1>
                                <p className="text-red-300">Tables are missing in your new Supabase project.</p>
                            </div>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <p className="text-gray-300 mb-4">You connected a new database URL. Please copy the SQL below and run it in the Supabase SQL Editor.</p>
                            
                            <div className="relative group">
                                <pre className="bg-gray-950 p-4 rounded-lg border border-gray-700 text-green-400 text-xs md:text-sm font-mono overflow-x-auto select-all whitespace-pre-wrap">
{`-- 1. Create Users Table
create table if not exists public.users (
  user_id text primary key,
  name text,
  mobile_no text,
  password text,
  role text,
  email text,
  photo_url text,
  is_online boolean default true,
  last_sync timestamp with time zone,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- 2. Create Messages Table
create table if not exists public.messages (
  id bigint generated by default as identity primary key,
  sender_id text not null,
  receiver_id text not null,
  message text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Create Daily Activity Table
create table if not exists public.daily_activity (
  id bigint generated by default as identity primary key,
  user_id text,
  type text,
  latitude double precision,
  longitude double precision,
  location text,
  description text,
  details text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 4. Create Followups Table
create table if not exists public.followups (
  id bigint generated by default as identity primary key,
  user_id text,
  subject text,
  followup_date timestamp with time zone,
  notes text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 5. Disable RLS for easier access
alter table public.users disable row level security;
alter table public.messages disable row level security;
alter table public.daily_activity disable row level security;
alter table public.followups disable row level security;

-- 6. Enable Realtime
alter publication supabase_realtime add table messages;`}
                                </pre>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button onClick={() => window.location.reload()} className="bg-accent hover:bg-cyan-400 text-black font-bold py-3 px-8 rounded-lg transition-all">
                                    I Have Run The SQL &rarr; Refresh App
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Map Component ---
        const MapComponent = ({ lat, lng }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                if (!mapRef.current) return;
                
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                }

                const latitude = lat || 0;
                const longitude = lng || 0;

                mapInstanceRef.current = L.map(mapRef.current).setView([latitude, longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(mapInstanceRef.current);
                
                if (lat && lng) {
                    L.marker([latitude, longitude]).addTo(mapInstanceRef.current);
                }

                setTimeout(() => mapInstanceRef.current.invalidateSize(), 100);

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, [lat, lng]);

            return <div ref={mapRef} className="h-full w-full rounded border border-accent z-0 relative"></div>;
        };

        // --- WhatsApp-like Chat Component (POLLING VERSION) ---
        const ChatSystem = ({ user }) => {
            const [contacts, setContacts] = useState([]);
            const [activeContact, setActiveContact] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const [loadingMessages, setLoadingMessages] = useState(false);
            const [showMobileChat, setShowMobileChat] = useState(false);
            const messagesEndRef = useRef(null);

            // 1. POLLING CONTACTS & PRESENCE HEARTBEAT
            useEffect(() => {
                // Heartbeat to keep self online
                const heartbeat = setInterval(async () => {
                   await supabase.from('users').update({ last_sync: new Date().toISOString(), is_online: true }).eq('user_id', user.user_id);
                }, 60000); // 1 min

                const fetchContacts = async () => {
                    const { data, error } = await supabase.from('users').select('*').neq('user_id', user.user_id);
                    if (!error && data) setContacts(data);
                    else if (error) {
                        // fallback to local if DB fails, but typically SetupWizard handles strict failures
                         const localUsers = getLocalUsers();
                         setContacts(localUsers.filter(u => u.user_id !== user.user_id));
                    }
                };
                
                // Initial Fetch
                fetchContacts();
                
                // Polling Interval for Contacts List (Online Status)
                const contactInterval = setInterval(fetchContacts, 10000); // Poll every 10s

                return () => {
                    clearInterval(heartbeat);
                    clearInterval(contactInterval);
                };
            }, [user.user_id]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            // 2. POLLING MESSAGES
            useEffect(() => {
                if (!activeContact) return;
                
                const fetchMessages = async (isPolling = false) => {
                    if (!isPolling) setLoadingMessages(true);
                    const { data, error } = await supabase
  .from('messages')
  .select('*')
  .or(
    `and(sender_id.eq.${user.user_id},receiver_id.eq.${activeContact.user_id})`,
    `and(sender_id.eq.${activeContact.user_id},receiver_id.eq.${user.user_id})`
  )
  .order('created_at', { ascending: true });

                    if (data) {
                        // Only update state if data changed (simple length check or deep compare)
                        setMessages(prev => {
                            if (prev.length !== data.length) {
                                setTimeout(scrollToBottom, 100);
                                return data;
                            }
                            // Check last message ID
                            if (data.length > 0 && prev.length > 0 && data[data.length-1].id !== prev[prev.length-1].id) {
                                setTimeout(scrollToBottom, 100);
                                return data;
                            }
                            return prev; 
                        });
                    }
                    if (!isPolling) setLoadingMessages(false);
                };

                fetchMessages(); // Initial load

                // Polling Interval for Messages
                const msgInterval = setInterval(() => fetchMessages(true), 3000); // Poll every 3s

                return () => clearInterval(msgInterval);
            }, [activeContact, user.user_id]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputText.trim() || !activeContact) return;

                const payload = {
                    sender_id: user.user_id,
                    receiver_id: activeContact.user_id,
                    message: inputText.trim(),
                    created_at: new Date().toISOString()
                };

                // Optimistic UI update
                setMessages(prev => [...prev, payload]);
                setInputText("");
                setTimeout(scrollToBottom, 100);

                const { error } = await supabase.from('messages').insert([payload]);
                if (error) {
                    console.error("Send failed", error);
                    handleSupabaseError(error);
                }
            };

            const selectContact = (contact) => {
                setActiveContact(contact);
                setShowMobileChat(true);
            };

            const handleBack = () => {
                setShowMobileChat(false);
                setActiveContact(null);
            };

            const formatTime = (isoString) => {
                if(!isoString) return '';
                const d = new Date(isoString);
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            return (
                <div className="flex h-[calc(100vh-100px)] md:h-full bg-cardbg rounded-xl overflow-hidden shadow-2xl border border-gray-700">
                    <div className={`w-full md:w-1/3 border-r border-gray-700 flex flex-col ${showMobileChat ? 'hidden md:flex' : 'flex'} bg-chatpanel`}>
                        <div className="p-4 bg-chatheader border-b border-gray-700 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-gray-200">Chats</h3>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {contacts.length === 0 ? (
                                <div className="p-4 text-center text-gray-500 text-sm">No contacts found.</div>
                            ) : (
                                contacts.map(c => (
                                    <div 
                                        key={c.user_id} 
                                        onClick={() => selectContact(c)}
                                        className={`flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-700 transition-colors border-b border-gray-800 ${activeContact?.user_id === c.user_id ? 'bg-gray-700' : ''}`}
                                    >
                                        <div className="relative">
                                            <img src={c.photo_url || "https://via.placeholder.com/40"} alt="User" className="w-12 h-12 rounded-full object-cover" />
                                            {c.is_online && <span className="absolute bottom-0 right-0 online-dot border border-gray-800"></span>}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-baseline">
                                                <h4 className="text-white font-semibold truncate">{c.name}</h4>
                                                {c.is_online && <span className="text-[10px] text-green-500 font-bold">ONLINE</span>}
                                            </div>
                                            <p className="text-sm text-gray-400 truncate">{c.user_id}</p>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    <div className={`w-full md:w-2/3 flex flex-col bg-[#0b141a] relative ${!showMobileChat ? 'hidden md:flex' : 'flex'}`}>
                         <div className="chat-bg-pattern"></div>
                        {activeContact ? (
                            <>
                                <div className="p-3 bg-chatheader flex items-center gap-3 border-b border-gray-700 z-10 shadow-sm">
                                    <button onClick={handleBack} className="md:hidden text-gray-300">
                                        <Icons.Back />
                                    </button>
                                    <div className="relative">
                                        <img src={activeContact.photo_url || "https://via.placeholder.com/40"} className="w-10 h-10 rounded-full object-cover" />
                                        {activeContact.is_online && <span className="absolute bottom-0 right-0 online-dot border border-gray-700"></span>}
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-white">{activeContact.name}</h3>
                                        <p className="text-xs text-gray-400">
                                            {activeContact.is_online ? <span className="text-green-400">Online</span> : (activeContact.last_sync ? `Last seen: ${new Date(activeContact.last_sync).toLocaleTimeString()}` : activeContact.user_id)}
                                        </p>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar z-10">
                                    {loadingMessages ? (
                                        <div className="flex justify-center mt-10"><div className="loader"></div></div>
                                    ) : (
                                        messages.map((msg, index) => {
                                            const isMe = msg.sender_id === user.user_id;
                                            return (
                                                <div key={index} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'}`}>
                                                    <div className={`message-bubble ${isMe ? 'message-sent text-white' : 'message-received text-white'}`}>
                                                        <span>{msg.message}</span>
                                                        <span className="message-time">{formatTime(msg.created_at)}</span>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                <form onSubmit={sendMessage} className="p-3 bg-chatheader flex gap-2 items-center z-10">
                                    <input 
                                        type="text" 
                                        className="flex-1 bg-[#2a3942] text-white rounded-lg px-4 py-3 outline-none border border-transparent focus:border-gray-600 transition-colors"
                                        placeholder="Type a message"
                                        value={inputText}
                                        onChange={e => setInputText(e.target.value)}
                                    />
                                    <button type="submit" className="bg-teal hover:bg-teal-500 p-3 rounded-full transition-colors text-white">
                                        <Icons.Send />
                                    </button>
                                </form>
                            </>
                        ) : (
                            <div className="hidden md:flex flex-col items-center justify-center h-full text-gray-400 z-10">
                                <div className="bg-gray-800 p-6 rounded-full mb-4">
                                    <Icons.Chat />
                                </div>
                                <h3 className="text-xl font-bold">Tracker Web Chat</h3>
                                <p className="text-sm mt-2">Send and receive messages with your team.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Login Component ---
        const LoginScreen = ({ onLogin, onDbCheckFail }) => {
            const [form, setForm] = useState({ role: '', id: '', password: '', mobile: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (!form.role) throw new Error('Please select a role');
                    if (!form.id) throw new Error('ID is required');
                    
                    if (form.role === 'employee' && !form.id.startsWith('SCS-')) throw new Error('Employee ID must start with SCS-');
                    if (form.role === 'admin' && !form.id.startsWith('ADM-')) throw new Error('Admin ID must start with ADM-');

                    const localUsers = getLocalUsers();
                    const normalizedId = form.id.trim().toUpperCase();
                    const user = localUsers.find(u => u.user_id === normalizedId && u.role === form.role);

                    if (!user) throw new Error('User not found. Check ID and Role (Local Auth).');
                    if (user.password !== form.password) throw new Error('Incorrect password.');
                    if (user.mobile_no !== form.mobile) throw new Error('Incorrect mobile number.');

                    // Try to sync with DB to ensure it exists. If this fails with table error, trigger Setup Wizard.
                    const syncErr = await ensureSupabaseUser(user);
                    if (syncErr) {
                         if (syncErr.code === 'PGRST205') {
                             onDbCheckFail(); // Trigger the Setup Wizard
                             setLoading(false);
                             return; // Stop login
                         } else {
                             console.warn("Background Sync Warning:", syncErr);
                         }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    onLogin(user);

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="hidden md:flex w-64 bg-primary flex-col items-center p-6 border-r border-gray-700">
                        <h1 className="text-2xl font-bold text-accent mb-10 flex items-center gap-2">ðŸš€ Tracker</h1>
                        <div className="text-center mb-8">
                             <p className="text-gray-300">Secure Field Force Management System</p>
                        </div>
                    </aside>

                    <main className="flex-1 bg-main-gradient p-8 md:p-16 overflow-y-auto flex flex-col justify-center">
                        <div className="w-full max-w-lg mx-auto bg-cardbg p-8 rounded-xl shadow-2xl border border-gray-700">
                            <h2 className="text-3xl font-bold text-white mb-8 text-center">Login</h2>
                            {error && <div className="bg-red-500/20 border border-red-500 text-red-200 p-3 rounded mb-4 text-sm text-center font-semibold">{error}</div>}
                            
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="form-group">
                                    <label className="block text-white font-bold mb-2">Role</label>
                                    <select 
                                        className="proto-input focus:ring-2 focus:ring-accent"
                                        value={form.role}
                                        onChange={e => setForm({...form, role: e.target.value, password: ''})}
                                        required
                                    >
                                        <option value="">-- Select Role --</option>
                                        <option value="employee">Employee</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label className="block text-white font-bold mb-2">{form.role === 'admin' ? 'Admin ID' : 'Employee ID'}</label>
                                    <input 
                                        type="text" 
                                        placeholder={form.role === 'admin' ? 'ADM-...' : 'SCS-...'}
                                        className="proto-input focus:ring-2 focus:ring-accent"
                                        value={form.id}
                                        onChange={e => setForm({...form, id: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="block text-white font-bold mb-2">Mobile Number</label>
                                    <input 
                                        type="tel" 
                                        className="proto-input focus:ring-2 focus:ring-accent"
                                        value={form.mobile}
                                        onChange={e => setForm({...form, mobile: e.target.value})}
                                        required
                                    />
                                </div>
                                {form.role && (
                                    <div className="form-group fade-in">
                                        <label className="block text-white font-bold mb-2">Password</label>
                                        <input 
                                            type="password" 
                                            className="proto-input focus:ring-2 focus:ring-accent"
                                            value={form.password}
                                            onChange={e => setForm({...form, password: e.target.value})}
                                            required
                                        />
                                    </div>
                                )}
                                <button type="submit" disabled={loading} className="w-full bg-accent hover:bg-cyan-400 text-black font-bold py-3 px-6 rounded-lg transition-all mt-6 disabled:opacity-50">
                                    {loading ? 'Logging in...' : 'Login'}
                                </button>
                            </form>
                        </div>
                    </main>
                </div>
            );
        };

        // --- Dashboard Components ---
        const Dashboard = ({ user }) => (
            <div className="bg-cardbg p-6 rounded-2xl shadow-lg border border-gray-700">
                <h2 className="text-2xl font-bold mb-4 text-white">Welcome, {user.name}</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="p-4 bg-gray-800 rounded border border-gray-600">
                        <h3 className="text-accent font-bold mb-2 flex items-center gap-2"><Icons.Activity/> Daily Activity</h3>
                        <p className="text-sm text-gray-300">Mark attendance and log visits.</p>
                    </div>
                    <div className="p-4 bg-gray-800 rounded border border-gray-600">
                        <h3 className="text-accent font-bold mb-2 flex items-center gap-2"><Icons.Chat/> Team Chat</h3>
                        <p className="text-sm text-gray-300">Communicate with colleagues instantly.</p>
                    </div>
                    <div className="p-4 bg-gray-800 rounded border border-gray-600">
                        <h3 className="text-accent font-bold mb-2 flex items-center gap-2"><Icons.FollowUp/> Follow Ups</h3>
                        <p className="text-sm text-gray-300">Track pending client tasks.</p>
                    </div>
                </div>
            </div>
        );

        const getAddressFromCoords = async (lat, lng) => {
            if (!lat || !lng) return 'N/A';
            const cacheKey = `${lat.toFixed(4)}_${lng.toFixed(4)}`;
            const cachedAddress = localStorage.getItem(`addr_${cacheKey}`);
            if (cachedAddress) return cachedAddress;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                if (data && data.display_name) {
                    localStorage.setItem(`addr_${cacheKey}`, data.display_name);
                    return data.display_name;
                }
                return 'Address not found';
            } catch (error) { return 'Error fetching address'; }
        };

        const DailyActivity = ({ user }) => {
            const [logs, setLogs] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const [filterEmp, setFilterEmp] = useState('');
            const [currentLoc, setCurrentLoc] = useState(null);
            const [checkInSession, setCheckInSession] = useState(localStorage.getItem(`checkin_${user.user_id}`));
            const [showVisitModal, setShowVisitModal] = useState(false);
            const [visitData, setVisitData] = useState({ client: '', purpose: '', location: '' });

            useEffect(() => {
                if(user.role === 'admin') {
                    setEmployees(getLocalUsers().filter(u => u.role === 'employee'));
                }
            }, [user]);

            const fetchLogs = async () => {
                setLoading(true);
                let query = supabase.from('daily_activity').select('*').order('created_at', { ascending: false });
                if (user.role === 'employee') query = query.eq('user_id', user.user_id);
                if (filterEmp) query = query.eq('user_id', filterEmp);
                
                const { data, error } = await query;
                if (error) handleSupabaseError(error);
                else {
                    const filtered = data.filter(l => new Date(l.created_at).toISOString().startsWith(filterDate));
                    setLogs(filtered);
                }
                setLoading(false);
            };

            useEffect(() => { fetchLogs(); }, [filterDate, filterEmp]);
            
            useEffect(() => {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(
                    pos => setCurrentLoc({ lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy }),
                    err => console.log("Init location check failed (optional):", err.message), 
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            }, []);

            const getLocation = () => new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
                        setCurrentLoc(loc);
                        resolve(loc);
                    },
                    err => {
                        let msg = err.message;
                        if(msg.includes("permissions policy")) msg = "Location access blocked by browser policy. Please try opening in a new window or checking settings.";
                        else if (err.code === 1) msg = "User denied location access.";
                        reject(new Error(msg));
                    }, 
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });

            const handleCheckIn = async () => {
                try {
                    const loc = await getLocation();
                    const payload = {
                        user_id: user.user_id,
                        type: 'checkin',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: await getAddressFromCoords(loc.lat, loc.lng),
                        description: 'Live GPS',
                        details: 'Session Started'
                    };
                    
                    let { data, error } = await supabase.from('daily_activity').insert([payload]).select();
                    if (error && error.code === '23503') {
                        await ensureSupabaseUser(user);
                        const retry = await supabase.from('daily_activity').insert([payload]).select();
                        data = retry.data; error = retry.error;
                    }
                    if (error) throw error;
                    
                    localStorage.setItem(`checkin_${user.user_id}`, data[0].id);
                    setCheckInSession(data[0].id);
                    setVisitData({ ...visitData, location: `Lat: ${loc.lat.toFixed(6)}, Lng: ${loc.lng.toFixed(6)}` });
                    setShowVisitModal(true);
                    fetchLogs();
                } catch (err) { handleSupabaseError(err); }
            };

            const handleCheckOut = async () => {
                if (!checkInSession) return alert('Not checked in!');
                try {
                    const loc = await getLocation();
                    const payload = {
                        user_id: user.user_id,
                        type: 'checkout',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: await getAddressFromCoords(loc.lat, loc.lng),
                        description: 'Live GPS',
                        details: `Linked Checkin ID: ${checkInSession}`
                    };
                    let { error } = await supabase.from('daily_activity').insert([payload]);
                    if (error && error.code === '23503') {
                         await ensureSupabaseUser(user);
                         const retry = await supabase.from('daily_activity').insert([payload]);
                         error = retry.error;
                    }
                    if (error) throw error;
                    localStorage.removeItem(`checkin_${user.user_id}`);
                    setCheckInSession(null);
                    alert('Checked Out');
                    fetchLogs();
                } catch (err) { handleSupabaseError(err); }
            };

            const submitVisit = async () => {
                try {
                    const loc = currentLoc || await getLocation();
                    const visitPayload = {
                        user_id: user.user_id,
                        type: 'visit',
                        created_at: new Date().toISOString(),
                        latitude: loc.lat,
                        longitude: loc.lng,
                        location: await getAddressFromCoords(loc.lat, loc.lng),
                        description: visitData.client,
                        details: visitData.purpose
                    };
                    let { error } = await supabase.from('daily_activity').insert([visitPayload]);
                    if (error && error.code === '23503') {
                        await ensureSupabaseUser(user);
                        const retry = await supabase.from('daily_activity').insert([visitPayload]);
                        error = retry.error;
                    }
                    if (error) throw error;
                    
                    // Auto Follow-up
                    await supabase.from('followups').insert([{
                        user_id: user.user_id,
                        subject: `Visit: ${visitData.client}`,
                        followup_date: new Date().toISOString(),
                        notes: `Purpose: ${visitData.purpose}`
                    }]);

                    alert('Visit Logged');
                    setShowVisitModal(false);
                    fetchLogs();
                } catch (err) { handleSupabaseError(err); }
            };

            return (
                <div className="bg-cardbg p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h2 className="text-2xl font-bold mb-6 text-white">Daily Activity</h2>
                    <div className="flex flex-wrap gap-4 mb-6">
                         <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm mb-1 font-semibold">Date:</label>
                            <input type="date" value={filterDate} onChange={e=>setFilterDate(e.target.value)} className="proto-input"/>
                        </div>
                        {user.role === 'admin' && (
                             <div className="flex-1 min-w-[150px]">
                                <label className="block text-sm mb-1 font-semibold">Employee:</label>
                                <select value={filterEmp} onChange={e=>setFilterEmp(e.target.value)} className="proto-input">
                                    <option value="">All Employees</option>
                                    {employees.map(e => <option key={e.user_id} value={e.user_id}>{e.name}</option>)}
                                </select>
                            </div>
                        )}
                    </div>
                    <div className="flex gap-3 mb-6">
                        <button onClick={handleCheckIn} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Check In</button>
                        <button onClick={handleCheckOut} className="bg-accent text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Check Out</button>
                        <button onClick={() => exportToCSV(logs, 'Activity')} className="bg-gray-600 text-white font-bold py-2 px-4 rounded">Export</button>
                    </div>
                    <div className="flex flex-col md:flex-row gap-4 mb-8 p-4 border border-gray-600 rounded-lg">
                        <div className="flex-1 text-sm space-y-1">
                             <p><strong>Status:</strong> <span className={currentLoc ? "text-success" : "text-danger"}>{currentLoc ? "GPS Active" : "Finding GPS..."}</span></p>
                            <p><strong>Lat/Lng:</strong> {currentLoc ? `${currentLoc.lat.toFixed(6)}, ${currentLoc.lng.toFixed(6)}` : "N/A"}</p>
                        </div>
                        <div className="flex-1 h-32 border border-gray-600 rounded">
                            <MapComponent lat={currentLoc?.lat} lng={currentLoc?.lng} />
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm">
                            <thead><tr><th>ID</th><th>Type</th><th>Time</th><th>Location</th><th>Details</th></tr></thead>
                            <tbody>
                                {loading ? <tr><td colSpan="5" className="p-4">Loading...</td></tr> : logs.map(l => (
                                    <tr key={l.id}>
                                        <td>{l.user_id}</td>
                                        <td className="capitalize">{l.type}</td>
                                        <td>{new Date(l.created_at).toLocaleTimeString()}</td>
                                        <td className="location-cell">{l.location}</td>
                                        <td>{l.description} {l.details}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={showVisitModal} onClose={() => setShowVisitModal(false)} title="ðŸ“ Log Visit">
                        <div className="space-y-4">
                            <input type="text" className="proto-input" placeholder="Client Name" value={visitData.client} onChange={e=>setVisitData({...visitData, client: e.target.value})} />
                            <textarea className="proto-input" rows="3" placeholder="Purpose" value={visitData.purpose} onChange={e=>setVisitData({...visitData, purpose: e.target.value})}></textarea>
                            <div className="flex gap-2 justify-center">
                                <button onClick={submitVisit} className="bg-accent text-black font-bold py-2 px-6 rounded">Submit</button>
                                <button onClick={() => setShowVisitModal(false)} className="bg-danger text-white font-bold py-2 px-6 rounded">Skip</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const FollowUps = ({ user }) => {
            const [list, setList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newF, setNewF] = useState({ subject: '', datetime: '', note: '' });

            const fetchF = async () => {
                setLoading(true);
                let query = supabase.from('followups').select('*').order('followup_date', { ascending: true });
                if (user.role === 'employee') query = query.eq('user_id', user.user_id);
                const { data, error } = await query;
                if (!error) setList(data);
                setLoading(false);
            };

            useEffect(() => { fetchF(); }, []);

            const handleAdd = async (e) => {
                e.preventDefault();
                const payload = { user_id: user.user_id, subject: newF.subject, followup_date: newF.datetime, notes: newF.note };
                let { error } = await supabase.from('followups').insert([payload]);
                if (error && error.code === '23503') {
                     await ensureSupabaseUser(user);
                     const retry = await supabase.from('followups').insert([payload]);
                     error = retry.error;
                }
                if (!error) { setNewF({ subject: '', datetime: '', note: '' }); fetchF(); }
                else handleSupabaseError(error);
            };

            return (
                <div className="bg-cardbg p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h2 className="text-2xl font-bold mb-4 text-white">Follow Ups</h2>
                    <form onSubmit={handleAdd} className="space-y-3 mb-6">
                        <input type="text" placeholder="Subject" className="proto-input" value={newF.subject} onChange={e=>setNewF({...newF, subject: e.target.value})} required />
                        <input type="datetime-local" className="proto-input" value={newF.datetime} onChange={e=>setNewF({...newF, datetime: e.target.value})} required />
                        <button type="submit" className="bg-accent text-black font-bold py-2 px-6 rounded">Add Task</button>
                    </form>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm">
                            <thead><tr><th>Subject</th><th>Date</th><th>Note</th><th>Action</th></tr></thead>
                            <tbody>
                                {list.map(i => (
                                    <tr key={i.id}>
                                        <td>{i.subject}</td>
                                        <td>{new Date(i.followup_date).toLocaleString()}</td>
                                        <td>{i.notes}</td>
                                        <td><button onClick={async()=>{await supabase.from('followups').delete().eq('id', i.id); fetchF();}} className="text-red-400">Done</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const UserProfile = ({ user, onUpdate }) => {
            const [formData, setFormData] = useState(user);
            const handleSave = async () => {
                const { error } = await supabase.from('users').update({
                    name: formData.name, mobile_no: formData.mobile_no, password: formData.password, photo_url: formData.photo_url
                }).eq('user_id', user.user_id);
                if (error) handleSupabaseError(error);
                else { updateLocalUserInStorage(formData); alert('Saved'); onUpdate(formData); }
            };
            return (
                <div className="bg-cardbg p-6 rounded-xl shadow-lg max-w-lg mx-auto border border-gray-700">
                    <h2 className="text-2xl font-bold mb-6 text-center">Profile</h2>
                    <div className="space-y-4">
                        <input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="proto-input" />
                        <input type="text" value={formData.mobile_no} onChange={e=>setFormData({...formData, mobile_no: e.target.value})} className="proto-input" />
                        <input type="password" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} className="proto-input" />
                        <button onClick={handleSave} className="w-full bg-success text-white font-bold py-2 rounded">Update</button>
                    </div>
                </div>
            );
        };

        const AdminManagement = ({ type }) => {
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ id: '', name: '', mobile: '', password: '' });
            
            const fetchUsers = () => {
                const role = type === 'admin' ? 'admin' : 'employee';
                setUsers(getLocalUsers().filter(u => u.role === role));
            };
            useEffect(fetchUsers, [type]);

            const handleAdd = async (e) => {
                e.preventDefault();
                const obj = { user_id: newUser.id.toUpperCase(), name: newUser.name, mobile_no: newUser.mobile, password: newUser.password, role: type === 'admin' ? 'admin' : 'employee' };
                const { error } = await supabase.from('users').upsert([obj]);
                if (error) handleSupabaseError(error);
                else { addLocalUserToStorage(obj); fetchUsers(); setNewUser({ id: '', name: '', mobile: '', password: '' }); alert('Added'); }
            };

            return (
                <div className="bg-cardbg p-4 rounded-xl shadow-lg border border-gray-700">
                    <h2 className="text-2xl font-bold mb-4">Manage {type}s</h2>
                    <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-5 gap-2 mb-4">
                        <input type="text" placeholder="ID" className="proto-input" value={newUser.id} onChange={e=>setNewUser({...newUser, id: e.target.value})} required/>
                        <input type="text" placeholder="Name" className="proto-input" value={newUser.name} onChange={e=>setNewUser({...newUser, name: e.target.value})} required/>
                        <input type="text" placeholder="Mobile" className="proto-input" value={newUser.mobile} onChange={e=>setNewUser({...newUser, mobile: e.target.value})} required/>
                        <input type="text" placeholder="Pass" className="proto-input" value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} required/>
                        <button className="bg-accent text-black font-bold rounded">Add</button>
                    </form>
                    <table className="min-w-full text-sm">
                        <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Action</th></tr></thead>
                        <tbody>
                            {users.map(u => (
                                <tr key={u.user_id}><td>{u.user_id}</td><td>{u.name}</td><td>{u.mobile_no}</td><td><button onClick={()=>{removeLocalUserFromStorage(u.user_id); fetchUsers();}} className="text-red-400">Delete</button></td></tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [section, setSection] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [showDbSetup, setShowDbSetup] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('current_user_session');
                if (saved) setUser(JSON.parse(saved));
                getLocalUsers(); // Seed
                
                // Initial DB Check for tables
                (async () => {
                    const { error } = await supabase.from('users').select('user_id').limit(1);
                    if (error && error.code === 'PGRST205') {
                        setShowDbSetup(true);
                    }
                })();
            }, []);

            const handleLogin = (userData) => { setUser(userData); localStorage.setItem('current_user_session', JSON.stringify(userData)); };
            const handleLogout = async () => {
                if(user) {
                    await supabase.from('users').update({ is_online: false, last_sync: new Date().toISOString() }).eq('user_id', user.user_id);
                }
                setUser(null); 
                localStorage.removeItem('current_user_session'); 
                setSection('dashboard'); 
            };

            if (showDbSetup) return <SetupWizard isOpen={true} />;
            if (!user) return <LoginScreen onLogin={handleLogin} onDbCheckFail={() => setShowDbSetup(true)} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden fixed top-4 right-4 z-50 p-2 bg-cardbg rounded-md text-accent border border-gray-600">
                        {sidebarOpen ? <Icons.Close /> : <Icons.Menu />}
                    </button>

                    <aside className={`fixed inset-y-0 left-0 z-40 w-64 bg-primary border-r border-gray-700 transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                        <div className="p-6 flex flex-col items-center border-b border-gray-700">
                            <h1 className="text-2xl font-bold text-accent mb-2">Tracker</h1>
                            <p className="font-semibold text-white text-center">{user.name}</p>
                            <p className="text-xs text-gray-400">{user.user_id}</p>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-2">
                            {[
                                { id: 'dashboard', icon: Icons.Dashboard, label: 'Dashboard' },
                                { id: 'chat', icon: Icons.Chat, label: 'Chats' },
                                { id: 'activity', icon: Icons.Activity, label: 'Daily Activity' },
                                { id: 'followups', icon: Icons.FollowUp, label: 'Follow Ups' },
                                { id: 'profile', icon: Icons.Profile, label: 'Profile' }
                            ].map(item => (
                                <button key={item.id} onClick={() => { setSection(item.id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${section === item.id ? 'bg-accent text-black font-bold' : 'hover:bg-cardbg text-gray-300'}`}>
                                    <item.icon /> {item.label}
                                </button>
                            ))}
                            {user.role === 'admin' && (
                                <div className="border-t border-gray-700 mt-4 pt-4">
                                    <p className="text-xs text-gray-500 uppercase px-2 mb-2">Admin</p>
                                    <button onClick={() => setSection('manage-emp')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${section === 'manage-emp' ? 'bg-accent text-black' : 'text-gray-300'}`}><Icons.Users/> Employees</button>
                                    <button onClick={() => setSection('manage-admin')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${section === 'manage-admin' ? 'bg-accent text-black' : 'text-gray-300'}`}><Icons.Admin/> Admins</button>
                                </div>
                            )}
                        </nav>
                        <div className="p-4 border-t border-gray-700">
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-red-900/30 text-red-400 hover:bg-red-900/50"><Icons.Logout /> Logout</button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto bg-main-gradient p-4 md:p-8">
                        {section === 'dashboard' && <Dashboard user={user} />}
                        {section === 'chat' && <ChatSystem user={user} />}
                        {section === 'activity' && <DailyActivity user={user} />}
                        {section === 'followups' && <FollowUps user={user} />}
                        {section === 'profile' && <UserProfile user={user} onUpdate={handleLogin} />}
                        {section === 'manage-emp' && user.role === 'admin' && <AdminManagement type="employee" />}
                        {section === 'manage-admin' && user.role === 'admin' && <AdminManagement type="admin" />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
